<!DOCTYPE html>
<html lang="en" data-desktop="classic">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The Blogger - AI-powered blog management system for WordPress">
    <title>The Blogger - Dashboard</title>
    <link rel="stylesheet" href="modern.css">
    <link rel="stylesheet" href="desktops.css">
    <link rel="stylesheet" href="desktop-switcher.css">
    <link rel="stylesheet" href="logo-effects.css">
    <script src="desktop-switcher.js"></script>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Login Screen -->
    <div id="loginScreen" class="screen" role="main">
        <div class="card-glass fade-in" style="max-width: 420px; width: 90%;">
            <div style="text-align: center;">
                <div class="login-logo-wrapper">
                    <div class="logo-glass-bg"></div>
                    <img src="logo.svg" alt="The Blogger Logo" class="logo-svg logo-pulse">
                </div>

                <form id="loginForm" style="text-align: left;">
                    <div class="form-group">
                        <div class="input-wrapper">
                            <input
                                type="text"
                                id="usernameInput"
                                placeholder="Username"
                                required
                                autocomplete="username"
                                aria-label="Username">
                            <label for="usernameInput">Username</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="input-wrapper">
                            <input
                                type="password"
                                id="passwordInput"
                                placeholder="Password"
                                required
                                autocomplete="current-password"
                                aria-label="Password">
                            <label for="passwordInput">Password</label>
                        </div>
                    </div>

                    <div id="loginError" class="error-message" role="alert" aria-live="polite" style="display: none;"></div>

                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: var(--space-6);">
                        <span>Sign In</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="hidden">
        <!-- Navigation -->
        <nav class="navbar" role="navigation" aria-label="Main navigation">
            <div class="navbar-content">
                <div class="navbar-brand">
                    <div class="navbar-logo-wrapper">
                        <img src="logo.svg" alt="The Blogger" class="logo-svg">
                    </div>
                    <span class="hide-mobile">The Blogger</span>
                </div>

                <div class="user-info">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <span id="userDisplay"></span>
                </div>

                <div class="nav-buttons">
                    <button
                        id="manageBlogsBtn"
                        onclick="location.href='admin.html'"
                        class="btn btn-secondary btn-sm hidden"
                        aria-label="Manage blogs">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M12 1v6m0 6v6m5.7-13.7l-4.2 4.2m0 6.9l4.2 4.2M23 12h-6m-6 0H1m20.7 5.7l-4.2-4.2m0-6.9l4.2-4.2"></path>
                        </svg>
                        <span>Manage Blogs</span>
                    </button>

                    <button
                        id="manageUsersBtn"
                        onclick="location.href='users.html'"
                        class="btn btn-secondary btn-sm hidden"
                        aria-label="Manage users">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87m-4-12a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>Manage Users</span>
                    </button>

                    <button
                        onclick="logout()"
                        class="btn btn-secondary btn-sm"
                        aria-label="Logout">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="container" style="padding-top: var(--space-12); padding-bottom: var(--space-12);">
            <header class="welcome" style="text-align: center; margin-bottom: var(--space-12);">
                <h1 class="gradient-text">
                    Welcome <span class="user-name" id="welcomeUsername"></span>
                </h1>
                <p style="font-size: var(--text-lg); color: var(--text-secondary);">
                    Select a blog to start creating amazing content
                </p>
            </header>

            <section aria-label="Your blogs">
                <div id="blogsList" class="blog-grid">
                    <!-- Loading skeleton -->
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let currentUser = null;

        // Check authentication on load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth-status');
                const data = await response.json();

                if (data.authenticated) {
                    currentUser = data.user;
                    showDashboard(data);
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboardScreen').classList.add('hidden');
        }

        async function showDashboard(data) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboardScreen').classList.remove('hidden');

            // Display user info
            const roleDisplay = {
                'super_admin': 'Super Admin',
                'admin': 'Admin',
                'editor': 'Editor'
            }[data.user.role] || data.user.role;

            document.getElementById('userDisplay').textContent = `${data.user.username} â€¢ ${roleDisplay}`;
            document.getElementById('welcomeUsername').textContent = data.user.username;

            // Show/hide buttons based on role
            try {
                const canManageResponse = await fetch('/api/can-manage-blogs');
                const canManageData = await canManageResponse.json();

                if (canManageData.canManage) {
                    document.getElementById('manageBlogsBtn').classList.remove('hidden');
                }

                if (data.user.role === 'super_admin') {
                    document.getElementById('manageUsersBtn').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to check permissions:', error);
            }

            loadBlogs();
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div><span>Signing in...</span>';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    checkAuth();
                } else {
                    const error = await response.json();
                    errorDiv.textContent = error.error || 'Invalid username or password';
                    errorDiv.style.display = 'flex';

                    // Re-enable button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<span>Sign In</span>';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'flex';

                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>Sign In</span>';
            }
        });

        // Logout function
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                location.reload();
            } catch (error) {
                console.error('Logout failed:', error);
                location.reload();
            }
        }

        // Load blogs
        async function loadBlogs() {
            const blogsList = document.getElementById('blogsList');

            try {
                const response = await fetch('/api/blogs');
                const blogs = await response.json();

                if (blogs.length === 0) {
                    blogsList.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: var(--space-16) var(--space-8);">
                            <svg width="120" height="120" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto var(--space-6); opacity: 0.3;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="9"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            <h3 style="color: var(--text-primary); margin-bottom: var(--space-3);">No Blogs Yet</h3>
                            <p style="color: var(--text-secondary); margin-bottom: var(--space-6);">
                                Add your first WordPress blog to start creating content.
                            </p>
                            ${currentUser?.role === 'super_admin' || currentUser?.role === 'admin' ?
                                '<button onclick="location.href=\'admin.html\'" class="btn btn-primary">Add Your First Blog</button>' :
                                '<p style="color: var(--text-tertiary); font-size: var(--text-sm);">Contact your administrator to add blogs.</p>'
                            }
                        </div>
                    `;
                    return;
                }

                blogsList.innerHTML = '';

                blogs.forEach(blog => {
                    const card = document.createElement('article');
                    card.className = 'blog-card';
                    card.setAttribute('aria-label', `Blog: ${blog.name}`);

                    const categoriesHTML = blog.categories && blog.categories.length > 0
                        ? `<div class="blog-categories" aria-label="Categories">
                            ${blog.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')}
                           </div>`
                        : '';

                    card.innerHTML = `
                        <h3>${blog.name}</h3>
                        <p class="blog-url">${blog.url}</p>
                        <p class="blog-description">${blog.description || 'No description provided'}</p>
                        ${categoriesHTML}
                        <button
                            onclick="selectBlog('${blog.id}')"
                            class="btn btn-primary"
                            style="width: 100%; margin-top: auto;"
                            aria-label="Create blog post for ${blog.name}">
                            <span>Create Blog Post</span>
                            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </button>
                    `;

                    blogsList.appendChild(card);
                });
            } catch (error) {
                console.error('Failed to load blogs:', error);
                blogsList.innerHTML = `
                    <div class="alert alert-error" style="grid-column: 1 / -1;">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <div>
                            <strong>Failed to load blogs</strong>
                            <p style="margin: 0;">Please refresh the page or contact support.</p>
                        </div>
                    </div>
                `;
            }
        }

        // Select blog and go to creation page
        function selectBlog(blogId) {
            sessionStorage.setItem('selectedBlogId', blogId);
            // Clear any previous session data
            sessionStorage.removeItem('brief');
            sessionStorage.removeItem('outline');
            sessionStorage.removeItem('article');
            sessionStorage.removeItem('images');
            location.href = 'create-brainstorm.html';
        }

        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>
