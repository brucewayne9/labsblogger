<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Blogger - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-improvements.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <img src="logo.png" alt="The Blogger" class="logo">
            <p class="tagline">AI Writing Assistant for Blogs</p>
            <form id="loginForm">
                <input type="text" id="usernameInput" placeholder="Username" required autocomplete="username">
                <input type="password" id="passwordInput" placeholder="Password" required autocomplete="current-password">
                <button type="submit">Login</button>
            </form>
            <div id="loginError" class="error"></div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardScreen" class="screen hidden">
        <nav class="navbar">
            <div class="navbar-brand">
                <img src="logo.png" alt="The Blogger" class="navbar-logo">
            </div>
            <div class="user-info">
                <span id="userDisplay"></span>
            </div>
            <div class="nav-buttons">
                <button id="manageBlogsBtn" onclick="location.href='admin.html'" class="btn-secondary hidden">‚öôÔ∏è Manage Blogs</button>
                <button id="manageUsersBtn" onclick="location.href='users.html'" class="btn-secondary hidden">üë• Manage Users</button>
                <button onclick="logout()" class="btn-secondary">üö™ Logout</button>
            </div>
        </nav>

        <div class="container">
            <div class="welcome">
                <h2>Welcome <span class="user-name" id="welcomeUsername"></span></h2>
                <p>Enjoy the writing session</p>
            </div>

            <div id="blogsList" class="blogs-grid">
                <!-- Blogs will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Check authentication on load
        async function checkAuth() {
            const response = await fetch('/api/auth-status');
            const data = await response.json();

            if (data.authenticated) {
                currentUser = data.user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboardScreen').classList.remove('hidden');

                // Display user info
                document.getElementById('userDisplay').textContent = `${data.user.username} (${data.user.role})`;
                document.getElementById('welcomeUsername').textContent = data.user.username;

                // Show/hide buttons based on role
                const canManageResponse = await fetch('/api/can-manage-blogs');
                const canManageData = await canManageResponse.json();

                if (canManageData.canManage) {
                    document.getElementById('manageBlogsBtn').classList.remove('hidden');
                }

                if (data.user.role === 'super_admin') {
                    document.getElementById('manageUsersBtn').classList.remove('hidden');
                }

                loadBlogs();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('dashboardScreen').classList.add('hidden');
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;

            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                checkAuth();
            } else {
                const error = await response.json();
                document.getElementById('loginError').textContent = error.error || 'Invalid username or password';
            }
        });

        // Logout
        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.reload();
        }

        // Load blogs
        async function loadBlogs() {
            const response = await fetch('/api/blogs');
            const blogs = await response.json();

            const blogsList = document.getElementById('blogsList');
            blogsList.innerHTML = '';

            blogs.forEach(blog => {
                const card = document.createElement('div');
                card.className = 'blog-card';
                card.innerHTML = `
                    <h3>${blog.name}</h3>
                    <p class="blog-url">${blog.url}</p>
                    <p class="blog-description">${blog.description}</p>
                    <div class="blog-categories">
                        ${blog.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')}
                    </div>
                    <button onclick="selectBlog('${blog.id}')" class="btn-primary">Create Blog Post</button>
                `;
                blogsList.appendChild(card);
            });
        }

        // Select blog and go to creation page
        function selectBlog(blogId) {
            sessionStorage.setItem('selectedBlogId', blogId);
            // Clear any previous session data
            sessionStorage.removeItem('brief');
            sessionStorage.removeItem('outline');
            sessionStorage.removeItem('article');
            sessionStorage.removeItem('images');
            location.href = 'create-brainstorm.html';
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>
