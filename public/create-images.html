<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images - The Blogger</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-improvements.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="logo.png" alt="The Blogger" class="navbar-logo">
            <h1>Create Blog Post</h1>
        </div>
        <div class="nav-buttons">
            <button onclick="location.href='index.html'" class="btn-secondary">‚Üê Back to Dashboard</button>
            <button onclick="logout()" class="btn-secondary">üö™ Logout</button>
        </div>
    </nav>

    <div class="container">
        <div class="progress-bar">
            <div class="progress-step" data-step="1">1</div>
            <div class="progress-step" data-step="2">2</div>
            <div class="progress-step" data-step="3">3</div>
            <div class="progress-step active" data-step="4">4</div>
            <div class="progress-step" data-step="5">5</div>
        </div>

        <h2>Select Your Images</h2>
        <p class="step-subtitle">Choose AI-suggested images or upload your own</p>

        <div class="image-source-toggle">
            <button class="toggle-btn active" onclick="showAIImages()" id="aiImagesBtn">
                ü§ñ AI Selected Images
            </button>
            <button class="toggle-btn" onclick="showUploadImages()" id="uploadImagesBtn">
                üì§ Upload My Own
            </button>
        </div>

        <div id="aiImagesSection">
            <div id="featuredCandidates">
                <div class="loader">Finding image options...</div>
            </div>
            <div class="button-group" id="aiButtons" style="display: none;">
                <button onclick="location.href='create-article.html'" class="btn-secondary">‚Üê Back</button>
                <button onclick="confirmAISelection()" class="btn-primary" id="confirmAIBtn" disabled>Continue ‚Üí</button>
            </div>
        </div>

        <div id="uploadImagesSection" class="hidden">
            <div class="upload-area">
                <h3>Upload Featured Image</h3>
                <div class="file-upload">
                    <input type="file" id="featuredUpload" accept="image/*" onchange="handleFeaturedUpload(event)">
                    <label for="featuredUpload" class="upload-label">
                        <span class="upload-icon">üì∏</span>
                        <span id="featuredFileName">Click to select an image</span>
                        <small>PNG, JPG, WEBP up to 10MB</small>
                    </label>
                </div>
                <div id="featuredPreview" class="hidden">
                    <img id="featuredPreviewImg" src="" alt="Preview">
                    <button onclick="removeFeaturedUpload()" class="btn-danger btn-sm">Remove</button>
                </div>
            </div>

            <div class="upload-area">
                <h3>Upload Article Images (Optional)</h3>
                <p class="upload-subtitle">Add images to place throughout your article</p>
                <div class="file-upload">
                    <input type="file" id="inlineUploads" accept="image/*" multiple onchange="handleInlineUploads(event)">
                    <label for="inlineUploads" class="upload-label">
                        <span class="upload-icon">üñºÔ∏è</span>
                        <span>Select multiple images</span>
                        <small>Choose several at once</small>
                    </label>
                </div>
                <div id="inlinePreview" class="upload-preview-grid"></div>
            </div>

            <div class="button-group">
                <button onclick="location.href='create-article.html'" class="btn-secondary">‚Üê Back</button>
                <button onclick="confirmUploadedImages()" class="btn-primary" id="confirmUploadBtn" disabled>Continue ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        let blogId = sessionStorage.getItem('selectedBlogId');
        let brief = JSON.parse(sessionStorage.getItem('brief') || '{}');
        let article = JSON.parse(sessionStorage.getItem('article') || '{}');
        let featuredCandidates = [];
        let selectedFeaturedId = null;
        let uploadedFeatured = null;
        let uploadedInline = [];

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            location.href = 'index.html';
        }

        async function init() {
            if (!blogId || !article.title) {
                location.href = 'create-brainstorm.html';
                return;
            }

            await loadFeaturedCandidates();
        }

        async function loadFeaturedCandidates() {
            const response = await fetch('/api/featured-candidates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ article, brief })
            });

            if (!response.ok) {
                document.getElementById('featuredCandidates').innerHTML = `
                    <div class="error-box">
                        <h3>‚ùå Failed to load images</h3>
                        <button onclick="loadFeaturedCandidates()" class="btn-primary">Try Again</button>
                    </div>
                `;
                return;
            }

            const data = await response.json();
            featuredCandidates = data.candidates;

            let html = '<div class="featured-grid">';
            featuredCandidates.forEach(candidate => {
                html += `
                    <div class="featured-candidate" data-image-id="${candidate.id}" onclick="selectFeaturedCandidate('${candidate.id}')">
                        <img src="${candidate.thumbUrl}" alt="${candidate.altText}">
                        <div class="featured-info">
                            <p class="featured-description">${candidate.description}</p>
                            <p class="featured-credit">${candidate.credit}</p>
                        </div>
                        <div class="featured-checkmark">‚úì</div>
                    </div>
                `;
            });
            html += '</div>';

            document.getElementById('featuredCandidates').innerHTML = html;
            document.getElementById('aiButtons').style.display = 'flex';
        }

        function selectFeaturedCandidate(imageId) {
            selectedFeaturedId = imageId;
            document.querySelectorAll('.featured-candidate').forEach(card => card.classList.remove('selected'));
            document.querySelector(`[data-image-id="${imageId}"]`).classList.add('selected');
            document.getElementById('confirmAIBtn').disabled = false;
        }

        async function confirmAISelection() {
            document.getElementById('confirmAIBtn').disabled = true;
            document.getElementById('confirmAIBtn').textContent = 'Processing...';

            const response = await fetch('/api/images', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ article, brief, selectedFeaturedId })
            });

            if (response.ok) {
                const data = await response.json();
                sessionStorage.setItem('images', JSON.stringify(data.images));
                location.href = 'create-publish.html';
            } else {
                alert('Failed to process images. Please try again.');
                document.getElementById('confirmAIBtn').disabled = false;
                document.getElementById('confirmAIBtn').textContent = 'Continue ‚Üí';
            }
        }

        function showAIImages() {
            document.getElementById('aiImagesSection').classList.remove('hidden');
            document.getElementById('uploadImagesSection').classList.add('hidden');
            document.getElementById('aiImagesBtn').classList.add('active');
            document.getElementById('uploadImagesBtn').classList.remove('active');
        }

        function showUploadImages() {
            document.getElementById('aiImagesSection').classList.add('hidden');
            document.getElementById('uploadImagesSection').classList.remove('hidden');
            document.getElementById('aiImagesBtn').classList.remove('active');
            document.getElementById('uploadImagesBtn').classList.add('active');
        }

        function handleFeaturedUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                return;
            }

            uploadedFeatured = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('featuredPreviewImg').src = e.target.result;
                document.getElementById('featuredPreview').classList.remove('hidden');
                document.getElementById('featuredFileName').textContent = file.name;
                document.getElementById('confirmUploadBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function removeFeaturedUpload() {
            uploadedFeatured = null;
            document.getElementById('featuredUpload').value = '';
            document.getElementById('featuredPreview').classList.add('hidden');
            document.getElementById('featuredFileName').textContent = 'Click to select an image';
            if (!uploadedInline.length) document.getElementById('confirmUploadBtn').disabled = true;
        }

        function handleInlineUploads(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.size <= 10 * 1024 * 1024) {
                    uploadedInline.push(file);
                }
            });
            displayInlinePreview();
            document.getElementById('confirmUploadBtn').disabled = false;
        }

        function displayInlinePreview() {
            const container = document.getElementById('inlinePreview');
            container.innerHTML = '';
            uploadedInline.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const card = document.createElement('div');
                    card.className = 'upload-preview-card';
                    card.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}">
                        <p>${file.name}</p>
                        <button onclick="removeInline(${index})" class="btn-danger btn-sm">Remove</button>
                    `;
                    container.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeInline(index) {
            uploadedInline.splice(index, 1);
            displayInlinePreview();
            if (!uploadedFeatured && !uploadedInline.length) {
                document.getElementById('confirmUploadBtn').disabled = true;
            }
        }

        async function confirmUploadedImages() {
            if (!uploadedFeatured && !uploadedInline.length) {
                alert('Please upload at least one image');
                return;
            }

            document.getElementById('confirmUploadBtn').disabled = true;
            document.getElementById('confirmUploadBtn').textContent = 'Uploading...';

            const formData = new FormData();
            if (uploadedFeatured) formData.append('featuredImage', uploadedFeatured);
            uploadedInline.forEach(file => formData.append('inlineImages', file));

            const response = await fetch('/api/upload-images', { method: 'POST', body: formData });

            if (response.ok) {
                const data = await response.json();
                sessionStorage.setItem('images', JSON.stringify(data.images));
                location.href = 'create-publish.html';
            } else {
                alert('Failed to upload images. Please try again.');
                document.getElementById('confirmUploadBtn').disabled = false;
                document.getElementById('confirmUploadBtn').textContent = 'Continue ‚Üí';
            }
        }

        init();
    </script>
</body>
</html>
